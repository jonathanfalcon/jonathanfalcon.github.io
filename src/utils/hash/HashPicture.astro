---
import type { PictureProps } from '@/types/utils/hash/componentProps'

import { getHashDataUrl } from './hash'
import { resolveImageMetadata } from './resolveImageMetadata'
import { Picture } from 'astro:assets'

type Props = PictureProps

const {
    src: rawSrc,
    hashOptions,
    widths = [900, 1400, 2000],
    decoding = 'async',
    formats = ['avif'],
    fallbackFormat = 'webp',
    ...props
} = Astro.props

const image = await resolveImageMetadata(rawSrc)

const base64DataUrl = await getHashDataUrl({
    src: image.src,
    ...hashOptions,
})

const style = `background: center / cover url(${base64DataUrl});`
---

<Picture
    src={image}
    widths={widths}
    decoding={decoding}
    formats={formats}
    fallbackFormat={fallbackFormat}
    style={style}
    {...props}
/>
